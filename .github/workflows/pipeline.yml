name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Call the reusable matrix test workflow
  test:
    uses: ./.github/workflows/go-matrix-test.yml
    with:
      working-directory: "."

  # Build and push Docker image (only on main branch)
  docker:
    needs: test
    if: github.ref == 'refs/heads/main'    permissions:
      contents: read
      packages: write    uses: ./.github/workflows/build-and-push-image.yml
    with:
      image-name: "inventory-service"  # Will be pushed to DOCKER_USERNAME/inventory-service
      platforms: "linux/amd64,linux/arm64"  # Multi-arch build
    secrets:
      registry-username: ${{ secrets.REGISTRY_USERNAME }}
      registry-password: ${{ secrets.REGISTRY_PASSWORD }}

  # Deploy to staging (only on main branch)
  deploy-staging:
    needs: docker
    if: github.ref == 'refs/heads/main'
    uses: ./.github/workflows/deploy-k8s.yml
    with:
      image: "inventory-service"  # Will be prepended with username
      namespace: "inventory-staging"
      deployment: "inventory-service"
      manifest-path: "./k8s"
    secrets:
      kubeconfig-content: ${{ secrets.KUBECONFIG_STAGING }}
      registry-username: ${{ secrets.REGISTRY_USERNAME }}